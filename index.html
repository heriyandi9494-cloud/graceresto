<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial, sans-serif; background: #f3f1f1; padding: 20px; color: #020008; }
    h2, h3 { text-align: center; }
    .input-area { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    input, button, select { padding: 10px; border-radius: 8px; border: 1px solid #01000d; transition: 0.3s; outline: none; }
    input:hover, button:hover, select:hover { box-shadow: 0 0 10px #4ad9ff; }
    button { cursor: pointer; background: #4a88ff; color: white; border: none; }
    .resetBtn { background: #e90303; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 30px; border: 1px solid #ef0404; }
    th, td { padding: 12px; border: 1px solid #2f07fb; text-align: center; }
    tr:hover { background: rgba(230, 238, 232, 0.1); box-shadow: inset 0 0 12px rgb(243, 244, 247); }
    .stok-habis { color: red; font-weight: bold; }
    canvas { margin-top: 30px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    @media(max-width:600px){ table, thead, tbody, th, td, tr { font-size: 12px; } }
    .header-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .header-container img.logo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }

    /* Tombol kiri atas */
    .top-left-buttons { display: flex; gap: 10px; position: absolute; top: 20px; left: 20px; z-index: 1000; }
    .top-left-buttons button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; color: white; background: #4a88ff; transition: 0.3s; }
    .top-left-buttons button.resetBtn { background: #ff4a4a; }
    .top-left-buttons button:hover { box-shadow: 0 0 10px #4ad9ff; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(22, 10, 242, 0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 0 15px rgba(1, 21, 200, 0.2); }
    .modal-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .modal-content th, .modal-content td { padding: 10px; border: 1px solid #400dfa; text-align: center; }
    .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; }
    .total-cards-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.hutang-card {
    background: #ffcc00;
    cursor: pointer;
    transition: 0.3s;
    text-align: center;
}

.hutang-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
    .total-card {
        background: #b7ee05;
        color: rgb(33, 2, 2);
        padding: 20px;
        border-radius: 12px;
        width: 250px;
        text-align: center;
        margin: 0 auto 20px auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: 0.3s;
    }
    .total-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    .total-card h3 { margin: 0 0 10px 0; font-size: 18px; }
    .total-card p { margin: 0; font-size: 22px; font-weight: bold; }
</style>
</head>
<body>

<!-- Tombol kiri atas -->
<div class="top-left-buttons">
    <button class="resetBtn" onclick="resetAll()">ğ‘ğ„ğ’ğ„ğ“ ğ’ğ„ğŒğ”ğ€</button>
    <button id="sisaJualanBtn">ğ’ğˆğ’ğ€ ğ‰ğ”ğ€ğ‹ğ€ğ</button>
    <button id="rangkumanBtn">ğ‘ğ€ğğ†ğŠğ”ğŒğ€ğ ğğ„ğğ‰ğ”ğ€ğ‹ğ€ğ</button>
</div>

<!-- Header -->
<div class="header-container">
    <img src="https://i.postimg.cc/0QKW4nSD/Screenshot-3.jpg" alt="Logo" class="logo">
    <h2>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ</h2>
</div>

<!-- Input Data Barang -->
<div class="input-area">
    <input type="text" id="namaBarang" placeholder="Nama Barang">
    <input type="number" id="stokAwal" placeholder="Stok Awal">
    <input type="number" id="harga" placeholder="Harga">
    <button onclick="tambahBarang()">ğ“ğ€ğŒğğ€ğ‡ ğğ€ğ‘ğ€ğğ†</button>
</div>

<!-- Card Total Pendapatan -->
<div class="total-cards-container">
    <div class="total-card">
        <h3>ğ“ğğ“ğ€ğ‹ ğğ„ğğƒğ€ğğ€ğ“ğ€ğ</h3>
        <p>ğ‘ğ <span id="totalPendapatan">0</span></p>
    </div>

    <!-- Card baru untuk Tabel Hutang -->
    <div class="total-card hutang-card" onclick="window.open('https://heriyandi9494-cloud.github.io/tabel-hutang/', '_blank')">
        <img src="https://i.postimg.cc/zvxD1Ym9/jj.gif" alt="Hutang" style="width:50px;height:50px;margin-bottom:10px;">
        <h3>ğ‡ğ”ğ“ğ€ğğ† ğŒğ„ğ‘ğ„ğŠğ€</h3>
    </div>
</div>

<!-- TABEL PENJUALAN -->
<table>
    <thead>
        <tr>
            <th>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ</th>
            <th>ğ’ğ­ğ¨ğ¤ ğ€ğ°ğšğ¥</th>
            <th>ğ’ğ­ğ¨ğ¤ ğ’ğ¢ğ¬ğš</th>
            <th>ğ“ğğ«ğ£ğ®ğšğ¥</th>
            <th>ğ‡ğšğ«ğ ğš</th>
            <th>ğ“ğ¨ğ­ğšğ¥</th>
            <th>ğ€ğ¤ğ¬ğ¢</th>
        </tr>
    </thead>
    <tbody id="dataBody"></tbody>
</table>

<!-- Modal Sisa Jualan -->
<div id="sisaJualanModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>ğ’ğ¢ğ¬ğš ğ‰ğ®ğšğ¥ğšğ§</h3>
    <table id="modalTable">
      <thead>
        <tr>
          <th>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ</th>
          <th>ğ’ğ­ğ¨ğ¤ ğ€ğ°ğšğ¥</th>
          <th>ğ’ğ­ğ¨ğ¤ ğ’ğ¢ğ¬ğš</th>
          <th>ğ“ğğ«ğ£ğ®ğšğ¥</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal Rangkuman -->
<div id="rangkumanModal" class="modal">
  <div class="modal-content">
    <span class="close-rangkuman">&times;</span>
    <h3 style="text-align:center;">ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ ğ‘ğ„ğ€ğƒğ˜ ğ‚ğ„ğŒğˆğ‹ğ€ğ</h3>
    <table id="rangkumanTable">
      <thead>
        <tr>
          <th>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ</th>
          <th>ğ‡ğšğ«ğ ğš</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="text-align:center; font-weight:bold;">ğ˜ğ€ğğ† ğŒğ€ğ” ğ‹ğ€ğğ†ğ’ğ”ğğ† ğ‚ğ‡ğ€ğ“ ğ˜ğ€</p>
  </div>
</div>
<!-- ========== DATA PEMBELI ========== -->
<h3>ğƒğ€ğ“ğ€ ğğ„ğŒğğ„ğ‹ğˆ</h3>
<div class="input-area">
    <input type="text" id="namaPembeli" placeholder="ğğ€ğŒğ€ ğğ„ğŒğğ„ğ‹ğˆ">
    <select id="pilihBarang">
        <option value="">-- ğğ¢ğ¥ğ¢ğ¡ ğğšğ«ğšğ§ğ  --</option>
    </select>
    <input type="number" id="jumlahBeli" placeholder="Jumlah Beli">
    <button onclick="tambahPembeli()">ğ“ğ€ğŒğğ€ğ‡ ğğ„ğŒğğ„ğ‹ğˆ</button>
</div>

<table>
    <thead id="headerPembeli">
        <tr>
            <th>ğğ€ğŒğ€ ğğ„ğŒğğ„ğ‹ğˆ</th>
            <th>ğ‹ğ®ğ§ğšğ¬</th>
        </tr>
    </thead>
    <tbody id="dataPembeliBody"></tbody>
</table>

<!-- ========== GRAFIK PENJUALAN ========== -->
<canvas id="grafikPenjualan"></canvas>

<!-- ========== SETORAN HARIAN ========== -->
<h3>ğƒğ€ğ“ğ€ ğ’ğ„ğ“ğğ‘ğ€ğ ğ‡ğ€ğ‘ğˆğ€ğ</h3>
<div class="input-area">
    <input type="date" id="tanggalSetor">
    <input type="number" id="jumlahSetor" placeholder="Jumlah Setor">
    <button onclick="tambahSetoran()">ğ“ğ€ğŒğğ€ğ‡ ğ’ğ„ğ“ğğ‘ğ€ğ</button>
</div>

<table>
    <thead>
        <tr>
            <th>Tanggal</th>
            <th>Jumlah Setor</th>
            <th>Keterangan</th>
            <th>Aksi</th>
        </tr>
    </thead>
    <tbody id="dataSetorBody"></tbody>
</table>

<!-- Card Total Pendapatan Setoran -->
<div class="total-card" id="totalSetorCard">
    <h3>ğ“ğğ“ğ€ğ‹ ğğ„ğğƒğ€ğğ€ğ“ğ€ğ ğğ„ğğ‰ğ”ğ€ğ‹ğ€ğ</h3>
    <p>ğ‘ğ <span id="totalSetoran">0</span></p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ==================== FIREBASE CONFIG ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyA_GuaQSaD8iqN7U27QnWYaNR3IbYWJlvo",
  authDomain: "graceresto.firebaseapp.com",
  projectId: "graceresto",
  storageBucket: "graceresto.firebasestorage.app",
  messagingSenderId: "1090466230530",
  appId: "1:1090466230530:web:2e33caa74557d458d6d21b",
  measurementId: "G-0VJ5GP9T29"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database().ref("penjualan");
const pembeliRef = firebase.database().ref("pembeli");
const setoranRef = firebase.database().ref("setoran");

/* ==================== DATA SETORAN HARIAN ================== */
function tambahSetoran() {
    const tanggal = document.getElementById("tanggalSetor").value;
    const jumlah = parseInt(document.getElementById("jumlahSetor").value);
    if (!tanggal || !jumlah) return alert("Isi semua data setoran!");

    let id = setoranRef.push().key;
    setoranRef.child(id).set({
        id, tanggal, jumlah, setor: false
    });

    document.getElementById("tanggalSetor").value = "";
    document.getElementById("jumlahSetor").value = "";
}

/* ==================== UPDATE TABEL SETORAN ================== */
setoranRef.on("value", snapshot => {
    const tbody = document.getElementById("dataSetorBody");
    tbody.innerHTML = '';
    let totalSetoran = 0;

    snapshot.forEach(item => {
        const d = item.val();
        const cek = d.setor ? "checked" : "";
        if (d.setor) totalSetoran += d.jumlah;

        tbody.innerHTML += `<tr id="setor-${d.id}">
            <td>${d.tanggal}</td>
            <td>${d.jumlah}</td>
            <td>${d.setor ? 'Sudah disetor' : 'Belum disetor'}</td>
            <td><input type="checkbox" ${cek} onchange="toggleSetor('${d.id}', this)"></td>
        </tr>`;
    });

    document.getElementById("totalSetoran").innerText = totalSetoran;
});

/* ==================== TOGGLE SETOR ================== */
function toggleSetor(id, checkbox) {
    const row = document.getElementById(`setor-${id}`);
    setoranRef.child(id).update({ setor: checkbox.checked }).then(() => {
        // Update warna baris
        if (checkbox.checked) {
            row.style.backgroundColor = "lightgreen";
        } else {
            row.style.backgroundColor = "#ffb3b3";
        }

        // Update keterangan
        const keteranganCell = row.children[2]; // kolom ke-3 = Keterangan
        keteranganCell.innerText = checkbox.checked ? "Sudah disetor" : "Belum disetor";
    });
}
</script>
<script>
// ======= SISA PENJUALAN MODAL =======
const sisaModal = document.getElementById("sisaJualanModal");
const sisaBtn = document.getElementById("sisaJualanBtn");
const closeSisa = sisaModal.querySelector(".close");

sisaBtn.onclick = () => {
    const tbody = sisaModal.querySelector("tbody");
    tbody.innerHTML = '';
    if (!dbSnapshot) return;
    dbSnapshot.forEach(item => {
        let d = item.val();
        tbody.innerHTML += `<tr>
            <td>${d.nama}</td>
            <td>${d.stokAwal}</td>
            <td>${d.stokSisa}</td>
            <td>${d.terjual}</td>
        </tr>`;
    });
    sisaModal.style.display = "block";
};

closeSisa.onclick = () => sisaModal.style.display = "none";
window.onclick = (event) => { if (event.target == sisaModal) sisaModal.style.display = "none"; };

// ======= RANGKUMAN PENJUALAN MODAL =======
const rangkumanModal = document.getElementById("rangkumanModal");
const rangkumanBtn = document.getElementById("rangkumanBtn");
const closeRangkuman = rangkumanModal.querySelector(".close-rangkuman");

rangkumanBtn.onclick = () => {
    const tbody = rangkumanModal.querySelector("tbody");
    tbody.innerHTML = '';
    if (!dbSnapshot) return;
    dbSnapshot.forEach(item => {
        let d = item.val();
        tbody.innerHTML += `<tr>
            <td>${d.nama}</td>
            <td>${d.harga}</td>
        </tr>`;
    });
    rangkumanModal.style.display = "block";
};

closeRangkuman.onclick = () => rangkumanModal.style.display = "none";
window.onclick = (event) => { 
    if (event.target == rangkumanModal) rangkumanModal.style.display = "none"; 
};
</script>

<script>
let chart;
let barangList = [];
let pembeliData = [];
let dbSnapshot;

/* ==================== GRAFIK PENJUALAN ====================== */
function loadGrafik(labels, data) {
    if (chart) chart.destroy();
    const ctx = document.getElementById("grafikPenjualan");
    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Barang Terjual",
                data: data,
                backgroundColor: "#4a88ff",
                borderRadius: 10
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
}

/* ==================== TAMBAH BARANG ====================== */
function tambahBarang() {
    let nama = document.getElementById("namaBarang").value;
    let stok = parseInt(document.getElementById("stokAwal").value);
    let harga = parseInt(document.getElementById("harga").value);
    if (!nama || !stok || !harga) return alert("Isi semua data!");
    let id = db.push().key;
    db.child(id).set({ id, nama, stokAwal: stok, stokSisa: stok, terjual: 0, harga, total: 0 });
    document.getElementById("namaBarang").value = "";
    document.getElementById("stokAwal").value = "";
    document.getElementById("harga").value = "";
}

/* ==================== UPDATE PILIHAN BARANG ================= */
function updatePilihanBarang(snapshot) {
    const select = document.getElementById("pilihBarang");
    select.innerHTML = '<option value="">-- Pilih Barang --</option>';
    snapshot.forEach(item => {
        let d = item.val();
        select.innerHTML += `<option value="${d.id}" data-nama="${d.nama}" data-terjual="${d.terjual}">${d.nama}</option>`;
    });
}

/* ==================== UPDATE TABEL PEMBELI ================== */
function updateTabelPembeli() {
    const header = document.getElementById("headerPembeli");
    let ths = '<th>ğğ€ğŒğ€ ğğ„ğŒğğ„ğ‹ğˆ</th>';
    barangList.forEach(b => ths += `<th>${b.nama}</th>`);
    ths += '<th>KETERANGAN</th>';
    header.innerHTML = `<tr>${ths}</tr>`;

    const tbody = document.getElementById("dataPembeliBody");
    tbody.innerHTML = '';
    pembeliData.forEach((p, index) => {
        let bgColor = p.lunas ? 'lightgreen' : '#ffb3b3';
        let row = `<tr id="row-${index}" style="background:${bgColor}"><td>${p.nama}</td>`;
        barangList.forEach(b => { 
            row += `<td>${p.beli[b.id] || 0}</td>`; 
        });
        let isLunas = p.lunas || false;
        row += `<td>
            <input type="checkbox" ${isLunas ? 'checked' : ''} onchange="toggleLunas(${index}, this)">
            <span id="aksi-${index}">${isLunas ? 'Lunas' : ''}</span>
        </td>`;
        tbody.innerHTML += row;
    });
}

/* ==================== UPDATE TERJUAL BARANG ================= */
function updateTerjual(id, jumlah) {
    jumlah = parseInt(jumlah);
    db.child(id).once("value").then(snap => {
        let d = snap.val();
        let stokSisa = d.stokAwal - jumlah;
        if (stokSisa < 0) return alert("Stok tidak cukup!");
        db.child(id).update({ terjual: jumlah, stokSisa, total: jumlah * d.harga });
    });
}

/* ==================== TAMBAH PEMBELI ======================= */
function tambahPembeli() {
    let namaPembeli = document.getElementById("namaPembeli").value;
    let select = document.getElementById("pilihBarang");
    let barangId = select.value;
    let jumlahBeli = parseInt(document.getElementById("jumlahBeli").value);
    if (!namaPembeli || !barangId || !jumlahBeli) return alert("Isi semua data pembeli!");

    db.child(barangId).once("value").then(snap => {
        let d = snap.val();
        let stokSisa = d.stokSisa - jumlahBeli;
        if (stokSisa < 0) return alert("Stok tidak cukup!");

        db.child(barangId).update({
            terjual: d.terjual + jumlahBeli,
            stokSisa,
            total: (d.terjual + jumlahBeli) * d.harga
        });

        pembeliRef.orderByChild("nama").equalTo(namaPembeli).once("value", snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(childSnap => {
                    let beliData = childSnap.val().beli || {};
                    beliData[barangId] = (beliData[barangId] || 0) + jumlahBeli;
                    childSnap.ref.update({ beli: beliData });
                });
            } else {
                let idPembeli = pembeliRef.push().key;
                let beliData = {};
                beliData[barangId] = jumlahBeli;
                pembeliRef.child(idPembeli).set({ nama: namaPembeli, beli: beliData });
            }
        });

        document.getElementById("namaPembeli").value = "";
        document.getElementById("jumlahBeli").value = "";
        select.value = "";
    });
}

/* ==================== RESET SEMUA ======================== */
function resetAll() {
    if (confirm("Yakin hapus semua data?")) {
        db.remove();
        pembeliRef.remove();
        setoranRef.remove();
        pembeliData = [];
        updateTabelPembeli();
    }
}

/* ==================== TOGGLE LUNAS PEMBELI ================= */
function toggleLunas(index, checkbox) {
    let pembeli = pembeliData[index];
    let row = document.getElementById(`row-${index}`);
    let aksiCell = document.getElementById(`aksi-${index}`);
    row.style.background = checkbox.checked ? 'lightgreen' : '#ffb3b3';
    aksiCell.innerText = checkbox.checked ? 'Lunas' : '';

    pembeliRef.orderByChild("nama").equalTo(pembeli.nama).once("value", snapshot => {
        snapshot.forEach(item => {
            item.ref.update({ lunas: checkbox.checked });
        });
    });
}

/* ==================== HAPUS BARANG ======================= */
function hapusBarang(id) {
    if (confirm("Yakin hapus barang ini?")) db.child(id).remove();
}

/* ==================== LISTENER FIREBASE =================== */
db.on("value", snapshot => {
    dbSnapshot = snapshot;
    let body = "";
    let totalPendapatan = 0;
    let labels = [];
    let jumlahJual = [];
    snapshot.forEach(item => {
        let d = item.val();
        labels.push(d.nama);
        jumlahJual.push(d.terjual);
        totalPendapatan += d.total;
        let stokClass = d.stokSisa === 0 ? "stok-habis" : "";
        body += `<tr>
            <td>${d.nama}</td>
            <td>${d.stokAwal}</td>
            <td class="${stokClass}">${d.stokSisa}</td>
            <td><input type="number" min="0" value="${d.terjual}" onchange="updateTerjual('${d.id}', this.value)"></td>
            <td>${d.harga}</td>
            <td>${d.total}</td>
            <td><button onclick="hapusBarang('${d.id}')">Hapus</button></td>
        </tr>`;
    });
    document.getElementById("dataBody").innerHTML = body;
    document.getElementById("totalPendapatan").innerText = totalPendapatan;

    loadGrafik(labels, jumlahJual);

    barangList = [];
    snapshot.forEach(item => { let d = item.val(); barangList.push({ id: d.id, nama: d.nama }); });

    updatePilihanBarang(snapshot);
    updateTabelPembeli();
});

pembeliRef.on("value", snapshot => {
    pembeliData = [];
    snapshot.forEach(item => {
        let d = item.val();
        d.lunas = d.lunas || false;
        pembeliData.push(d);
    });
    updateTabelPembeli();
});

/* ==================== SETORAN HARIAN ===================== */
setoranRef.on("value", snapshot => {
    const tbody = document.getElementById("dataSetorBody");
    tbody.innerHTML = '';
    let totalSetoran = 0;

    snapshot.forEach(item => {
        const d = item.val();
        const cek = d.setor ? "checked" : "";
        if (d.setor) totalSetoran += d.jumlah;

        const bgColor = d.setor ? "lightgreen" : "#ffb3b3";

        tbody.innerHTML += `<tr id="setor-${d.id}" style="background:${bgColor}">
            <td>${d.tanggal}</td>
            <td>${d.jumlah}</td>
            <td>${d.setor ? 'Sudah disetor' : 'Belum disetor'}</td>
            <td><input type="checkbox" ${cek} onchange="toggleSetor('${d.id}', this)"></td>
        </tr>`;
    });

    document.getElementById("totalSetoran").innerText = totalSetoran;
});

function toggleSetor(id, checkbox) {
    setoranRef.child(id).update({ setor: checkbox.checked });
}
</script>
</body>
</html>
