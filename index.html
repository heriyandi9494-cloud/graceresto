<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial, sans-serif; background: #f3f1f1; padding: 20px; color: #020008; }
    h2, h3 { text-align: center; }
    .input-area { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    input, button, select { padding: 10px; border-radius: 8px; border: 1px solid #01000d; transition: 0.3s; outline: none; }
    input:hover, button:hover, select:hover { box-shadow: 0 0 10px #4ad9ff; }
    button { cursor: pointer; background: #4a88ff; color: white; border: none; }
    .resetBtn { background: #ff4a4a; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 30px; border: 1px solid #ef0404; }
    th, td { padding: 12px; border: 1px solid #2f07fb; text-align: center; }
    tr:hover { background: rgba(230, 238, 232, 0.1); box-shadow: inset 0 0 12px rgb(243, 244, 247); }
    .stok-habis { color: red; font-weight: bold; }
    canvas { margin-top: 30px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    @media(max-width:600px){ table, thead, tbody, th, td, tr { font-size: 12px; } }
    .header-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .header-container img.logo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }

    /* Tombol kiri atas */
    .top-left-buttons { display: flex; gap: 10px; position: absolute; top: 20px; left: 20px; z-index: 1000; }
    .top-left-buttons button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; color: white; background: #4a88ff; transition: 0.3s; }
    .top-left-buttons button.resetBtn { background: #ff4a4a; }
    .top-left-buttons button:hover { box-shadow: 0 0 10px #4ad9ff; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(22, 10, 242, 0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 0 15px rgba(1, 21, 200, 0.2); }
    .modal-content table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .modal-content th, .modal-content td { padding: 10px; border: 1px solid #400dfa; text-align: center; }
    .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; }
    .total-card {
    background: #4a88ff;
    color: white;
    padding: 20px;
    border-radius: 12px;
    width: 250px;
    text-align: center;
    margin: 0 auto 20px auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: 0.3s;
}
.total-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
.total-card h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
}
.total-card p {
    margin: 0;
    font-size: 22px;
    font-weight: bold;
}
</style>
</head>
<body>

<!-- Tombol kiri atas -->
<div class="top-left-buttons">
    <button class="resetBtn" onclick="resetAll()">ğ‘ğ„ğ’ğ„ğ“ ğ’ğ„ğŒğ”ğ€</button>
    <button id="sisaJualanBtn">ğ’ğˆğ’ğ€ ğ‰ğ”ğ€ğ‹ğ€ğ</button>
    <button id="rangkumanBtn">ğ‘ğ€ğğ†ğŠğ”ğŒğ€ğ ğğ„ğğ‰ğ”ğ€ğ‹ğ€ğ</button>
</div>

<!-- Header -->
<div class="header-container">
    <img src="https://i.postimg.cc/0QKW4nSD/Screenshot-3.jpg" alt="Logo" class="logo">
    <h2>ğƒğ€ğ…ğ“ğ€ğ‘ ğ‚ğ„ğŒğˆğ‹ğ€ğ ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ</h2>
</div>

<!-- Input Data Barang -->
<div class="input-area">
    <input type="text" id="namaBarang" placeholder="Nama Barang">
    <input type="number" id="stokAwal" placeholder="Stok Awal">
    <input type="number" id="harga" placeholder="Harga">
    <button onclick="tambahBarang()">ğ“ğ€ğŒğğ€ğ‡ ğğ€ğ‘ğ€ğğ†</button>
</div>
<!-- Card Total Pendapatan -->
<div class="total-card">
    <h3>Total Pendapatan</h3>
    <p>Rp <span id="totalPendapatan">0</span></p>
</div>
<!-- Tabel Penjualan -->
<table>
    <thead>
        <tr>
            <th>ğğšğ¦ğš ğğšğ«ğšğ§ğ </th>
            <th>ğ’ğ­ğ¨ğ¤ ğ€ğ°ğšğ¥</th>
            <th>ğ’ğ­ğ¨ğ¤ ğ’ğ¢ğ¬ğš</th>
            <th>ğ“ğğ«ğ£ğ®ğšğ¥</th>
            <th>ğ‡ğšğ«ğ ğš</th>
            <th>ğ“ğ¨ğ­ğšğ¥</th>
            <th>ğ€ğ¤ğ¬ğ¢</th>
        </tr>
    </thead>
    <tbody id="dataBody"></tbody>
</table>

<!-- Modal Sisa Jualan -->
<div id="sisaJualanModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>ğ’ğ¢ğ¬ğš ğ‰ğ®ğšğ¥ğšğ§</h3>
    <table id="modalTable">
      <thead>
        <tr>
          <th>ğğšğ¦ğš ğğšğ«ğšğ§ğ </th>
          <th>ğ’ğ­ğ¨ğ¤ ğ€ğ°ğšğ¥</th>
          <th>ğ’ğ­ğ¨ğ¤ ğ’ğ¢ğ¬ğš</th>
          <th>ğ“ğğ«ğ£ğ®ğšğ¥</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal Rangkuman Penjualan -->
<div id="rangkumanModal" class="modal">
  <div class="modal-content">
    <span class="close-rangkuman">&times;</span>
    <h3 style="text-align:center;">ğ†ğ‘ğ€ğ‚ğ„ ğ‘ğ„ğ’ğ“ğ ğ‘ğ„ğ€ğƒğ˜ ğ‚ğ„ğŒğˆğ‹ğ€ğ</h3>
    <table id="rangkumanTable">
      <thead>
        <tr>
          <th>ğğšğ¦ğš ğğšğ«ğšğ§ğ </th>
          <th>ğ‡ğšğ«ğ ğš</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p style="text-align:center; font-weight:bold;">ğ˜ğ€ğğ† ğŒğ€ğ” ğ‹ğ€ğğ†ğ’ğ”ğğ† ğ‚ğ‡ğ€ğ“ ğ˜ğ€</p>
  </div>
</div>

<!-- Grafik -->
<canvas id="grafikPenjualan"></canvas>

<!-- Input Data Pembeli -->
<h3>ğƒğ€ğ“ğ€ ğğ„ğŒğğ„ğ‹ğˆ</h3>
<div class="input-area">
    <input type="text" id="namaPembeli" placeholder="ğğ€ğŒğ€ ğğ„ğŒğğ„ğ‹ğˆ">
    <select id="pilihBarang">
        <option value="">-- ğğ¢ğ¥ğ¢ğ¡ ğğšğ«ğšğ§ğ  --</option>
    </select>
    <input type="number" id="jumlahBeli" placeholder="Jumlah Beli">
    <button onclick="tambahPembeli()">ğ“ğ€ğŒğğ€ğ‡ ğğ„ğŒğğ„ğ‹ğˆ</button>
</div>

<!-- Tabel Pembeli Horizontal Dinamis -->
<table>
    <thead id="headerPembeli">
        <tr>
            <th>ğğšğ¦ğš ğğğ¦ğ›ğğ¥ğ¢</th>
            <!-- Nama Barang akan ditambahkan dinamis -->
            <th>ğ‹ğ®ğ§ğšğ¬</th>
        </tr>
    </thead>
    <tbody id="dataPembeliBody"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ==================== FIREBASE CONFIG ======================
const firebaseConfig = {
  apiKey: "AIzaSyA_GuaQSaD8iqN7U27QnWYaNR3IbYWJlvo",
  authDomain: "graceresto.firebaseapp.com",
  projectId: "graceresto",
  storageBucket: "graceresto.firebasestorage.app",
  messagingSenderId: "1090466230530",
  appId: "1:1090466230530:web:2e33caa74557d458d6d21b",
  measurementId: "G-0VJ5GP9T29"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("penjualan");
const pembeliRef = firebase.database().ref("pembeli");

// ==================== TAMBAH BARANG ========================
function tambahBarang() {
    let nama = document.getElementById("namaBarang").value;
    let stok = parseInt(document.getElementById("stokAwal").value);
    let harga = parseInt(document.getElementById("harga").value);
    if (!nama || !stok || !harga) return alert("Isi semua data!");
    let id = db.push().key;
    db.child(id).set({ id, nama, stokAwal: stok, stokSisa: stok, terjual: 0, harga, total: 0 });
    document.getElementById("namaBarang").value = "";
    document.getElementById("stokAwal").value = "";
    document.getElementById("harga").value = "";
}

// ==================== LOAD TABEL & GRAFIK ==================
let chart;
function loadGrafik(labels, data) {
    if (chart) chart.destroy();
    const ctx = document.getElementById("grafikPenjualan");
    chart = new Chart(ctx, {
        type: "bar",
        data: { labels: labels, datasets: [{ label: "Barang Terjual", data: data, backgroundColor: "#4a88ff", borderRadius: 10 }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
}

function updatePilihanBarang(snapshot) {
    const select = document.getElementById("pilihBarang");
    select.innerHTML = '<option value="">-- Pilih Barang --</option>';
    snapshot.forEach(item => {
        let d = item.val();
        select.innerHTML += `<option value="${d.id}" data-nama="${d.nama}" data-terjual="${d.terjual}">${d.nama}</option>`;
    });
}

// =================== TABEL PEMBELI DINAMIS =================
let barangList = [];
let pembeliData = [];
let dbSnapshot;

function updateTabelPembeli() {
    const header = document.getElementById("headerPembeli");
    let ths = '<th>ğğ€ğŒğ€ ğğ„ğŒğğ„ğ‹ğˆ</th>';
    barangList.forEach(b => ths += `<th>${b.nama}</th>`);
    ths += '<th>KETERANGAN</th>';
    header.innerHTML = `<tr>${ths}</tr>`;

    const tbody = document.getElementById("dataPembeliBody");
    tbody.innerHTML = '';
    pembeliData.forEach((p, index) => {
        let bgColor = p.lunas ? 'lightgreen' : '#ffb3b3';
        let row = `<tr id="row-${index}" style="background:${bgColor}"><td>${p.nama}</td>`;
        barangList.forEach(b => { 
            row += `<td>${p.beli[b.id] || 0}</td>`; 
        });
        let isLunas = p.lunas || false;
row += `<td>
            <input type="checkbox" ${isLunas ? 'checked' : ''} onchange="toggleLunas(${index}, this)">
            <span id="aksi-${index}">${isLunas ? 'Lunas' : ''}</span>
        </td>`;

        tbody.innerHTML += row;
    });
}

// =================== UPDATE TERJUAL ========================
function updateTerjual(id, jumlah) {
    jumlah = parseInt(jumlah);
    db.child(id).once("value").then(snap => {
        let d = snap.val();
        let stokSisa = d.stokAwal - jumlah;
        if (stokSisa < 0) return alert("Stok tidak cukup!");
        db.child(id).update({ terjual: jumlah, stokSisa, total: jumlah * d.harga });
    });
}

// =================== TAMBAH PEMBELI ========================
function tambahPembeli() {
    let namaPembeli = document.getElementById("namaPembeli").value;
    let select = document.getElementById("pilihBarang");
    let barangId = select.value;
    let jumlahBeli = parseInt(document.getElementById("jumlahBeli").value);
    if (!namaPembeli || !barangId || !jumlahBeli) return alert("Isi semua data pembeli!");

    db.child(barangId).once("value").then(snap => {
        let d = snap.val();
        let stokSisa = d.stokSisa - jumlahBeli;
        if (stokSisa < 0) return alert("Stok tidak cukup!");

        db.child(barangId).update({
            terjual: d.terjual + jumlahBeli,
            stokSisa,
            total: (d.terjual + jumlahBeli) * d.harga
        });

        pembeliRef.orderByChild("nama").equalTo(namaPembeli).once("value", snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(childSnap => {
                    let beliData = childSnap.val().beli || {};
                    beliData[barangId] = (beliData[barangId] || 0) + jumlahBeli;
                    childSnap.ref.update({ beli: beliData });
                });
            } else {
                let idPembeli = pembeliRef.push().key;
                let beliData = {};
                beliData[barangId] = jumlahBeli;
                pembeliRef.child(idPembeli).set({ nama: namaPembeli, beli: beliData });
            }
        });

        document.getElementById("namaPembeli").value = "";
        document.getElementById("jumlahBeli").value = "";
        select.value = "";
    });
}

// ====================== RESET ===============================
function resetAll() {
    if (confirm("Yakin hapus semua data?")) {
        db.remove();
        pembeliRef.remove();
        pembeliData = [];
        updateTabelPembeli();
    }
}

// ====================== LISTENER ===========================
db.on("value", snapshot => {
    dbSnapshot = snapshot;
    let body = "";
    let totalPendapatan = 0;
    let labels = [];
    let jumlahJual = [];
    snapshot.forEach(item => {
        let d = item.val();
        labels.push(d.nama);
        jumlahJual.push(d.terjual);
        totalPendapatan += d.total;
        let stokClass = d.stokSisa === 0 ? "stok-habis" : "";
        body += `<tr>
            <td>${d.nama}</td>
            <td>${d.stokAwal}</td>
            <td class="${stokClass}">${d.stokSisa}</td>
            <td><input type="number" min="0" value="${d.terjual}" onchange="updateTerjual('${d.id}', this.value)"></td>
            <td> ${d.harga}</td>
            <td> ${d.total}</td>
            <td><button onclick="hapusBarang('${d.id}')">Hapus</button></td>
        </tr>`;
    });
    document.getElementById("dataBody").innerHTML = body;
    document.getElementById("totalPendapatan").innerText = totalPendapatan;
    loadGrafik(labels, jumlahJual);

    barangList = [];
    snapshot.forEach(item => { let d = item.val(); barangList.push({ id: d.id, nama: d.nama }); });
    updatePilihanBarang(snapshot);
    updateTabelPembeli();
});

pembeliRef.on("value", snapshot => {
    pembeliData = [];
    snapshot.forEach(item => {
    let d = item.val();
    d.lunas = d.lunas || false; // default false
    pembeliData.push(d);
});

    updateTabelPembeli();
});

// ================= MODAL SISA JUALAN ========================
const sisaBtn = document.getElementById("sisaJualanBtn");
const modal = document.getElementById("sisaJualanModal");
const closeModal = modal.querySelector(".close");
const modalTableBody = modal.querySelector("tbody");

sisaBtn.onclick = () => {
  modal.style.display = "block";
  modalTableBody.innerHTML = "";
  dbSnapshot.forEach(item => {
    let d = item.val();
    modalTableBody.innerHTML += `<tr>
      <td>${d.nama}</td>
      <td>${d.stokAwal}</td>
      <td>${d.stokSisa}</td>
      <td>${d.terjual}</td>
    </tr>`;
  });
};

closeModal.onclick = () => modal.style.display = "none";
window.onclick = function(event) {
  if (event.target == modal) modal.style.display = "none";
  if (event.target == rangkumanModal) rangkumanModal.style.display = "none";
};

// ================= MODAL RANGKUMAN ========================
const rangkumanBtn = document.getElementById("rangkumanBtn");
const rangkumanModal = document.getElementById("rangkumanModal");
const closeRangkuman = rangkumanModal.querySelector(".close-rangkuman");
const rangkumanTableBody = rangkumanModal.querySelector("tbody");

rangkumanBtn.onclick = () => {
    rangkumanModal.style.display = "block";
    rangkumanTableBody.innerHTML = "";

    db.once("value").then(snapshot => {
        snapshot.forEach(item => {
            let d = item.val();
            rangkumanTableBody.innerHTML += `<tr>
                <td>${d.nama}</td>
                <td> ${d.harga}</td>
            </tr>`;
        });
    });
};

closeRangkuman.onclick = () => rangkumanModal.style.display = "none";

// ================= OTHER FUNCTIONS ========================
function toggleLunas(index, checkbox) {
    let pembeli = pembeliData[index];
    let row = document.getElementById(`row-${index}`);
    let aksiCell = document.getElementById(`aksi-${index}`);

    // Ubah warna row
    row.style.background = checkbox.checked ? 'lightgreen' : '#ffb3b3';

    // Update teks Lunas
    aksiCell.innerText = checkbox.checked ? 'Lunas' : '';

    // Update ke Firebase
    pembeliRef.orderByChild("nama").equalTo(pembeli.nama).once("value", snapshot => {
        snapshot.forEach(item => {
            item.ref.update({ lunas: checkbox.checked });
        });
    });
}

function hapusBarang(id) {
    if (confirm("Yakin hapus barang ini?")) db.child(id).remove();
}

function hapusPembeli(nama) {
    pembeliRef.orderByChild("nama").equalTo(nama).once("value", snapshot => {
        snapshot.forEach(item => { item.ref.remove(); });
    });
}
</script>

</body>
</html>
